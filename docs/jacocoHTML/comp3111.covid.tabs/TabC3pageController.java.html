<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TabC3pageController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">deCOVID</a> &gt; <a href="index.source.html" class="el_package">comp3111.covid.tabs</a> &gt; <span class="el_source">TabC3pageController.java</span></div><h1>TabC3pageController.java</h1><pre class="source lang-java linenums">package comp3111.covid.tabs;

import java.time.LocalDate;
import java.util.ArrayList;

import javax.annotation.processing.Generated;

import comp3111.covid.Context;
import comp3111.covid.dataAnalysis.DateConverter;
import comp3111.covid.datastorage.*;
import javafx.beans.property.SimpleDoubleProperty;
import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.chart.LineChart;
import javafx.scene.chart.NumberAxis;
import javafx.scene.chart.XYChart;
import javafx.scene.chart.XYChart.Data;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Label;
import javafx.scene.control.Slider;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.util.Pair;
import javafx.util.StringConverter;
import javafx.scene.control.cell.PropertyValueFactory;

import org.apache.commons.math3.stat.regression.SimpleRegression;

/**
 * Controller for Tab C3
 * Rate of vaccination report.
 */
<span class="fc" id="L35">public class TabC3pageController {</span>

<span class="fc" id="L37">	protected Database database = Context.getInstance().getDatabase();</span>
<span class="fc" id="L38">	protected DateConverter dateConverter = Context.getInstance().getDateConverter();</span>
	
	@FXML private NumberAxis xAxis;
    @FXML private NumberAxis yAxis;
	@FXML private LineChart&lt;Number, Number&gt; regressionChart;
	@FXML protected ComboBox&lt;Pair&lt;String, LocationProperty&gt;&gt; xAxisCbx;
	@FXML private Slider dateSlider;
	@FXML private Label noDataLabel1;
	@FXML private Label noDataLabel2;
	@FXML private TableColumn&lt;TableView&lt;RegressionTableData&gt;, String&gt; regPropCol;
	@FXML private TableColumn&lt;TableView&lt;RegressionTableData&gt;, Double&gt; regValCol;
	@FXML private TableView&lt;RegressionTableData&gt; regTable;
	/**
	 * An array of string to be displayed on the combobox.
	 * Each string corresponds to a {@link comp3111.covid.datastorage.LocationProperty}.
	 */
<span class="fc" id="L54">	final protected String[] LOC_PROP_TEXT = {&quot;Population&quot;, &quot;Population Density&quot;, &quot;Median Age&quot;, &quot;Number of People Aged 65 or above&quot;, &quot;Number of People Aged 70 or above&quot;, &quot;GDP per Capita&quot;, &quot;Diabetes Prevalence&quot;};</span>
<span class="fc" id="L55">	final private String noDataText1 = &quot;No Data Avaialble for the given time and x-axis&quot;;</span>
<span class="fc" id="L56">	final private String noDataText2 = &quot;Change the slider to find data in another day!&quot;;</span>
	/**
	 * The chosen {@link comp3111.covid.datastorage.LocationProperty} from the combobox.
	 */
<span class="fc" id="L60">	protected LocationProperty selectedProperty = null;</span>
	/**
	 * The chosen date from the slider.
	 */
<span class="fc" id="L64">	protected LocalDate selectedDate = null;</span>
	
	/**
	 * This method initializes this controller after loading all FMXL elements.
	 * In particular, it dose four things.
	 * 1. It sets up the combobox to store pairs of LocationProperty and its corresponding string, and changes the value of {@link TabC3pageController#selectedProperty} upon change of choice.
	 * 2. It sets the y-axis of the chart to display percentage.
	 * 3. It sets the string converter of the slider and Listener fro the slider.
	 * 4. It sets the {@link javafx.scene.control.cell.PropertyValueFactory} for the table's columns.
	 */
	public void initialize() {
		// Initialize the comboBox to contain pairs of name of LocationProperty and LocationProperty Enums
<span class="nc" id="L76">		ObservableList&lt;Pair&lt;String, LocationProperty&gt;&gt; pairs = this.generateLocPropPairs();</span>
<span class="nc" id="L77">		xAxisCbx.setItems(pairs);</span>
<span class="nc" id="L78">		this.selectedDate = this.database.getEarliest();</span>
		
		// make combobox contains Pair objects but display the name of property
<span class="nc" id="L81">		xAxisCbx.setConverter(new StringConverter&lt;Pair&lt;String, LocationProperty&gt;&gt;(){</span>
			@Override @Generated(&quot;&quot;)
			public String toString(Pair&lt;String, LocationProperty&gt; object) {
<span class="nc" id="L84">				return object.getKey();</span>
			}
			public Pair&lt;String, LocationProperty&gt; fromString(String string){
<span class="nc" id="L87">				return xAxisCbx.getItems().stream().filter(p -&gt; p.getKey().equals(string)).findFirst().orElse(null);</span>
			}
		});
		
		// So that y-axis displays percentage 
<span class="nc" id="L92">		yAxis.setTickLabelFormatter(new StringConverter&lt;Number&gt;() {</span>
			public String toString(Number rate) {
<span class="nc" id="L94">				return (rate + &quot;%&quot;);</span>
			}
			
			public Number fromString(String string) {
<span class="nc" id="L98">				return null;</span>
			}
		});
		
		// so that the graph updates itself when the combobox chosen value is changed
<span class="nc" id="L103">		xAxisCbx.valueProperty().addListener((obs, oldval, newval) -&gt; {</span>
<span class="nc" id="L104">			this.selectedProperty = newval.getValue();</span>
<span class="nc" id="L105">			xAxis.setLabel(LOC_PROP_TEXT[selectedProperty.value()]);</span>
<span class="nc" id="L106">			this.generateView();</span>
<span class="nc" id="L107">		});</span>
		
		// so that the slider displays label of dates
<span class="nc" id="L110">		this.dateSlider.setLabelFormatter(new StringConverter&lt;&gt;() {</span>
			@Override @Generated(&quot;&quot;)
			public String toString(Double object) {
<span class="nc" id="L113">				return dateConverter.longToString(object.longValue());</span>
			}
			@Override @Generated(&quot;&quot;)
			public Double fromString(String string) {
<span class="nc" id="L117">				return (double)dateConverter.dateToLong(LocalDate.parse(string));</span>
			}
		});
		
		// so that the graph updates itself when the slider is changed, and make increments in slider to be steps
<span class="nc" id="L122">		this.dateSlider.valueProperty().addListener((obs, oldval, newval)-&gt;{</span>
<span class="nc" id="L123">			final double roundedValue = Math.floor(newval.doubleValue());</span>
<span class="nc" id="L124">			dateSlider.valueProperty().set(roundedValue);</span>
<span class="nc" id="L125">			this.selectedDate = dateConverter.longToDate((long)roundedValue);</span>
<span class="nc" id="L126">			this.generateView();</span>
<span class="nc" id="L127">		});</span>
		
<span class="nc" id="L129">		this.regPropCol.setCellValueFactory(new PropertyValueFactory&lt;TableView&lt;RegressionTableData&gt;, String&gt;(&quot;regName&quot;));</span>
<span class="nc" id="L130">		this.regValCol.setCellValueFactory(new PropertyValueFactory&lt;TableView&lt;RegressionTableData&gt;, Double&gt;(&quot;regValue&quot;));</span>
<span class="nc" id="L131">	}</span>
	/**
	 * This method stores set the minimum and maximum value of the slider to reflect the database's earliest and latest date that a data belongs to.
	 * Invoked after importing the dataset.
	 */
	public void initAfterImport() {
<span class="nc" id="L137">		LocalDate maxDate = this.database.getLatest();</span>
<span class="nc" id="L138">		LocalDate minDate = this.database.getEarliest();</span>
<span class="nc" id="L139">		this.selectedDate = minDate;</span>
<span class="nc" id="L140">		this.dateSlider.maxProperty().set(dateConverter.dateToLong(maxDate));</span>
<span class="nc" id="L141">		this.dateSlider.minProperty().set(dateConverter.dateToLong(minDate));</span>
<span class="nc" id="L142">	}</span>
	
	/**
	 * This method constructs a list of pairs of {@link comp3111.covid.datastorage.LocationProperty} values and their corresponding names.
	 * A helper method for {@link TabC3pageController#initialize()}.
	 * @return {@link javafx.collections.ObservableList} of {@link javafx.util.Pair} of all {@link comp3111.covid.datastorage.LocationProperty} values and their corresponding names.
	 */
	protected ObservableList&lt;Pair&lt;String, LocationProperty&gt;&gt; generateLocPropPairs(){
<span class="fc" id="L150">		ObservableList&lt;Pair&lt;String, LocationProperty&gt;&gt; result = FXCollections.observableArrayList();</span>
<span class="fc" id="L151">		int i = 0;</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">		for(LocationProperty prop : LocationProperty.values()) {</span>
<span class="fc" id="L153">			Pair&lt;String, LocationProperty&gt; newPair = new Pair&lt;String, LocationProperty&gt;(LOC_PROP_TEXT[i], prop);</span>
<span class="fc" id="L154">			result.add(newPair);</span>
<span class="fc" id="L155">			++i;</span>
		}
<span class="fc" id="L157">		return result;</span>
	}
	
	/**
	 *  Main method for generating the chart and the table.
	 */
	private void generateView() {
<span class="nc" id="L164">		ArrayList&lt;Pair&lt;Number, Number&gt;&gt; rawData = database.searchDataPair(this.selectedDate, this.selectedProperty);</span>
<span class="nc" id="L165">		RegressionResult regressionResult = this.generateRegression(rawData);</span>
<span class="nc" id="L166">		this.generateChart(rawData, regressionResult);</span>
<span class="nc" id="L167">		this.generateTable(regressionResult);</span>
		
<span class="nc" id="L169">	}</span>
	
	/**
	 * Main method for generating the regression chart.
	 * @param data				A {@link java.util.ArrayList} of raw data found from the database.
	 * @param regressionResult	A {@link RegressionResult} object storing regression values stored generated from raw data.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	private void generateChart(ArrayList&lt;Pair&lt;Number, Number&gt;&gt; data, RegressionResult regressionResult) {
<span class="nc" id="L178">		this.regressionChart.getData().clear();</span>
	
		//Handle no data found
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if(data.isEmpty()) {</span>
<span class="nc" id="L182">			this.regressionChart.setTitle(&quot;&quot;);</span>
<span class="nc" id="L183">			this.noDataLabel1.setText(noDataText1);</span>
<span class="nc" id="L184">			this.noDataLabel2.setText(noDataText2);</span>
<span class="nc" id="L185">			this.noDataLabel1.setVisible(true);</span>
<span class="nc" id="L186">			this.noDataLabel2.setVisible(true);</span>
<span class="nc" id="L187">			return;</span>
		}
		
<span class="nc" id="L190">		this.noDataLabel1.setVisible(false);</span>
<span class="nc" id="L191">		this.noDataLabel2.setVisible(false);</span>
		
<span class="nc" id="L193">		this.regressionChart.setTitle(&quot;Rgerssion based on data on &quot; + this.selectedDate);</span>
		
		//turn actual data into series
<span class="nc" id="L196">		XYChart.Series&lt;Number, Number&gt; scatter = this.generateScatterSeries(data);</span>
<span class="nc" id="L197">		XYChart.Series&lt;Number, Number&gt; regression = this.generateRegressionSeries(data, regressionResult);</span>
		
		//display the chart
<span class="nc" id="L200">		this.regressionChart.getData().addAll(scatter, regression);</span>
<span class="nc" id="L201">		this.regressionChart.getScene().getStylesheets().add(getClass().getResource(&quot;/stylesheet/root.css&quot;).toExternalForm());</span>
<span class="nc" id="L202">	}</span>
	
	/**
	 * A method to get the largest X value in a list of raw data.
	 * A helper method to {@link TabC3pageController#generateRegressionSeries(ArrayList, RegressionResult)}.
	 * @param sourceData	A list of raw data from the Database.
	 * @return				the largest X value in the list of raw data.
	 */
	private double getLastX(ArrayList&lt;Pair&lt;Number, Number&gt;&gt; sourceData) {
<span class="fc" id="L211">		double maxX = 0;</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">		for(Pair&lt;Number, Number&gt; pair : sourceData) {</span>
<span class="fc" id="L213">			double x = pair.getKey().doubleValue();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">			maxX = (maxX &gt; x) ? maxX : x; </span>
<span class="fc" id="L215">		}</span>
<span class="fc" id="L216">		return maxX;</span>
	}
	/**
	 * A method to generate a {@link RegressionResult} object from data obtained from database.
	 * @param rawData	list of data obtained from database.
	 * @return			{@link RegressionResult} object containing the values of regression performed on the set of data.
	 */
	protected RegressionResult generateRegression(ArrayList&lt;Pair&lt;Number, Number&gt;&gt; rawData) {
<span class="fc" id="L224">		SimpleRegression regression = new SimpleRegression(true);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">		for(Pair&lt;Number, Number&gt; datum : rawData) {</span>
<span class="fc" id="L226">			regression.addData(datum.getKey().doubleValue(), datum.getValue().doubleValue());</span>
<span class="fc" id="L227">		}</span>
<span class="fc" id="L228">		return new RegressionResult(regression.getIntercept(), regression.getSlope(), regression.getSignificance(), regression.getR(), regression.getRSquare());</span>
	}
	/**
	 * A method creating the regression line in the chart.
	 * @param rawData			list of data obtained from the database.
	 * @param regressionResult	A {@link RegressionResult} object containing the values of regression performed on Raw Data.
	 * @return					A {@link javafx.scene.chart.XYChart.Series} object for creating the regression line in the chart.
	 */
	protected XYChart.Series&lt;Number, Number&gt; generateRegressionSeries(ArrayList&lt;Pair&lt;Number, Number&gt;&gt; rawData, RegressionResult regressionResult) {
<span class="fc" id="L237">		double slope = regressionResult.getSlope();</span>
<span class="fc" id="L238">		double intercept = regressionResult.getIntercept();</span>
		
<span class="fc" id="L240">		XYChart.Series&lt;Number, Number&gt; regressionSeries = new XYChart.Series&lt;&gt;();</span>
<span class="fc" id="L241">		regressionSeries.setName(&quot;Regression Line&quot;);</span>
<span class="fc" id="L242">		double lastX = getLastX(rawData);</span>
<span class="fc" id="L243">		double lastY = slope * lastX + intercept;</span>
<span class="fc" id="L244">		regressionSeries.getData().add(new Data&lt;Number, Number&gt;(0, intercept));</span>
<span class="fc" id="L245">		regressionSeries.getData().add(new Data&lt;Number, Number&gt;(lastX, lastY));</span>
<span class="fc" id="L246">		return regressionSeries;</span>
	}
	/**
	 * A method creating the scatter plot series for raw data in the chart.
	 * @param rawData	Raw data to be plotted on the graph.
	 * @return			A {@link javafx.scene.chart.XYChart.Series} object for creating the scatter plot in the chart.
	 */
	protected XYChart.Series&lt;Number, Number&gt; generateScatterSeries(ArrayList&lt;Pair&lt;Number, Number&gt;&gt; rawData){
<span class="fc" id="L254">		XYChart.Series&lt;Number, Number&gt; scatter = new XYChart.Series&lt;&gt;();</span>
<span class="fc" id="L255">		scatter.setName(&quot;actual data points&quot;);</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">		for(Pair&lt;Number, Number&gt; pair : rawData) {</span>
<span class="fc" id="L257">			scatter.getData().add(new Data&lt;Number, Number&gt;(pair.getKey(), pair.getValue()));</span>
<span class="fc" id="L258">		}</span>
<span class="fc" id="L259">		return scatter;</span>
	}
	
	// ---------------- for table ----------------------
	
	/**
	 * A helper class for holding data to be put in the table.
	 */
	public class RegressionTableData {
		private final SimpleStringProperty regName;
		private final SimpleDoubleProperty regValue;
		
<span class="nc" id="L271">		RegressionTableData(String propertyName, double propertyValue){</span>
<span class="nc" id="L272">			this.regName = new SimpleStringProperty(propertyName);</span>
<span class="nc" id="L273">			this.regValue = new SimpleDoubleProperty(Math.round(propertyValue * 100000d) / 100000d);</span>
<span class="nc" id="L274">		}</span>
		
		public String getRegName() {
<span class="nc" id="L277">			return this.regName.get();</span>
		}
		
		public double getRegValue() {
<span class="nc" id="L281">			return this.regValue.get();</span>
		}
	}
	/**
	 * A helper class to hold values generated from performing simple linear regression on a set of data.
	 * It holds these properties:
	 * 1. Intercept
	 * 2. Slope
	 * 3. Statistical significance of the slope value
	 * 4. Pearson's Correlation Coefficient (commonly called R value)
	 * 5. Coefficient of Determination (commonly known as R-squared)
	 */
	public class RegressionResult {
		private double intercept;
		private double slope;
		private double significance;
		private double rValue;
		private double rSquared;
		
<span class="fc" id="L300">		RegressionResult(double intercept, double slp, double sig, double r, double rs){</span>
<span class="fc" id="L301">			this.intercept = intercept;</span>
<span class="fc" id="L302">			this.slope = slp;</span>
<span class="fc" id="L303">			this.significance = sig;</span>
<span class="fc" id="L304">			this.rValue = r;</span>
<span class="fc" id="L305">			this.rSquared = rs;</span>
<span class="fc" id="L306">		}</span>
		
		double getIntercept() {
<span class="fc" id="L309">			return this.intercept;</span>
		}
		
		double getSlope() {
<span class="fc" id="L313">			return this.slope;</span>
		}
		
		double getSignificance() {
<span class="nc" id="L317">			return this.significance;</span>
		}
		
		double getR() {
<span class="nc" id="L321">			return this.rValue;</span>
		}
		
		double getRsquared() {
<span class="nc" id="L325">			return this.rSquared;</span>
		}
	}
	/**
	 * The main method for generating the table.
	 * Its main functionality is to set the title on the left column and extract data from the given {@link RegressionResult} object to fill in the right row.
	 * @param regressionResult	{@link RegressionResult} object generated from data from the database.
	 */
	private void generateTable(RegressionResult regressionResult) {
<span class="nc" id="L334">		ObservableList&lt;RegressionTableData&gt; oList = FXCollections.observableArrayList();</span>
<span class="nc" id="L335">		oList.add(new RegressionTableData(&quot;Intercept&quot;, regressionResult.getIntercept()));</span>
<span class="nc" id="L336">		oList.add(new RegressionTableData(&quot;Slope&quot;, regressionResult.getSlope()));</span>
<span class="nc" id="L337">		oList.add(new RegressionTableData(&quot;Level of Significance of Slope&quot;, regressionResult.getSignificance()));</span>
<span class="nc" id="L338">		oList.add(new RegressionTableData(&quot;Pearson's Correlation Coefficient (R)&quot;, regressionResult.getR()));</span>
<span class="nc" id="L339">		oList.add(new RegressionTableData(&quot;Coefficient of Determination (R-squared)&quot;, regressionResult.getRsquared()));</span>
		// to make the columns get the right data from RegressionTableData
<span class="nc" id="L341">		this.regTable.setItems(oList);</span>
<span class="nc" id="L342">	}</span>
	
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>